# Android出荷作業端末向け API 仕様（概要版 / 既存WMSテーブル準拠）



---

## 1. 目的 / 対象範囲

* 倉庫出荷作業（ピッキング）に必要な **ログイン**、**倉庫選択**、**タスク取得**、**ピック実績登録**、**タスク完了**、**ログアウト** を提供。
* **認証子**は `wms_pickers.code` とパスワード（暗号化保存）を使用。メールアドレスは使用しない。
* L5:swaggerを利用しAPI ドキュメントを作成する。
* url のprefixは /api 

---

## 2. 関連テーブル（抜粋）

### 2.1 wms_pickers

* `id, code(Unique), name, password(hashed), default_warehouse_id, is_active, timestamps`

### 2.2 wms_picking_tasks

* `id, wave_id, wms_picking_area_id, warehouse_id, earning_id, trade_id, status(PENDING|PICKING|SHORTAGE|COMPLETED), task_type(WAVE|REALLOCATION), picker_id, started_at, completed_at, timestamps`
* 代表インデックス: `(wave_id, wms_picking_area_id, status)`, `(wave_id, status)`

### 2.3 wms_picking_item_results

* `id, picking_task_id, trade_item_id, item_id, real_stock_id, location_id, wms_picking_area_id, walking_order, ordered_qty, ordered_qty_type, planned_qty, planned_qty_type, picked_qty, picked_qty_type, shortage_qty, has_physical_shortage(generated), status(PICKING|COMPLETED|SHORTAGE), picked_at, picker_id, timestamps`
* 代表インデックス: `(wms_picking_area_id, walking_order, item_id)`, `(picking_task_id)`

> 並び順: 端末表示は **`wms_picking_area_id, walking_order, item_id`** を優先（歩行順最適化）。ピッキングエリア（常温/冷蔵/冷凍/フォークリフト）ごとにタスクが分割されます。

---

## 3. 認証 / セッション

* 認証方式: `POST /auth/login` でトークン発行（形式は実装側の標準: JWT など）。
* セッション終了: `POST /auth/logout`。
* 監査: ログイン/ログアウト時に `picker_id`, `device_id`, `timestamp` をログ記録。

### 3.1 エンドポイント

1. **ログイン** `POST /auth/login`

* 入力: `{ code, password, device_id? }`
* 成功: `{ token, picker: { id, code, name, default_warehouse_id } }`
* 失敗: 401（コード/パスワード不一致、`is_active=0`）

2. **ログアウト** `POST /auth/logout`

* 成功: 204

3. **自分情報** `GET /me`

* 成功: `{ id, code, name, default_warehouse_id }`

---

## 4. マスタ取得

> 既存の倉庫テーブルを利用（本仕様ではスキーマ省略）。

4. **倉庫一覧** `GET /warehouses`

* 出力: `[{ id, code, name }]`

5. **ピッキングエリア一覧** `GET /picking-areas?warehouse_id=...`

* 出力: `[{ id, code, name, warehouse_id }]`

> ※名称・フィールドは既存マスタに合わせる。端末は **`warehouse_id` を必須** とする前提。

---

## 5. ピッキングタスク

### 5.1 一覧取得

6. **タスク一覧** `GET /picking/tasks`

* クエリ: `warehouse_id(required)`, `wms_picking_area_id?`, `wave_id?`, `status? (PENDING|PICKING|SHORTAGE|COMPLETED)`, `assigned? (mine|unassigned|all)`, `page?, per_page?`
* 絞込ロジック:

    * `assigned=mine` → `picker_id = me`
    * `assigned=unassigned` → `picker_id IS NULL` かつ `status IN (PENDING, SHORTAGE)`
    * 省略時は `all`
* 戻り: `[{ id, wave_id, wms_picking_area_id, warehouse_id, status, task_type, picker_id, started_at, completed_at, earning_id, trade_id }]`

### 5.2 詳細取得

7. **タスク詳細** `GET /picking/tasks/{id}`

* 戻り:

    * `task`: 上記フィールド
    * `items`: `wms_picking_item_results` を **`wms_picking_area_id asc, walking_order asc, item_id asc`** で返却

        * 各行: `{ id, trade_item_id, item_id, location_id, wms_picking_area_id, walking_order, ordered_qty, ordered_qty_type, planned_qty, planned_qty_type, picked_qty, picked_qty_type, shortage_qty, status }`

### 5.3 割当/開始/完了

8. **タスク割当** `POST /picking/tasks/{id}/assign`

* 入力: `{ picker_id? }`（省略時は自分）
* 条件: `status IN (PENDING, SHORTAGE)` かつ `picker_id IS NULL`（管理者は上書き可の実装も可）
* 失敗: 409（他者が先に割当/開始）、403（権限）

9. **開始** `POST /picking/tasks/{id}/start`

* 作用: `status=PICKING`, `started_at=now`, `picker_id=me`（未割当なら同時割当）
* 失敗: 409（状態不整合）

10. **完了** `POST /picking/tasks/{id}/complete`

* 既定: **全行 `status=COMPLETED` で `COMPLETED`**。未達ありは `SHORTAGE` で完了可（業務設定で可否制御）。
* 作用: `completed_at=now`, `status` を最終判定。
* 失敗: 422（未処理行ありで `allow_short=false` 等）

### 5.4 行ピック（数量登録）

11. **ピック登録** `POST /picking/tasks/{id}/items/{item_result_id}/pick`

* 入力: `{ picked_qty(+), picked_qty_type?, location_id?, real_stock_id? }`
* 作用: `picked_qty` を加算 or 置換（実装ポリシー選択）。`picked_at=now`, `picker_id=me`。
* 行状態自動更新:

    * `picked_qty == planned_qty` → `status=COMPLETED`, `shortage_qty=0`
    * `picked_qty < planned_qty` → `status=PICKING`, `shortage_qty = planned_qty - picked_qty`
    * `picked_qty > planned_qty` → 422（過剰）※許容時は調整ロジックを別途
* タスク状態自動更新:

    * 1 行でも `shortage_qty>0` が残る → `wms_picking_tasks.status = SHORTAGE`（暫定）
    * 全行 `COMPLETED` → `wms_picking_tasks.status = COMPLETED`
* 失敗: 409（在庫/予約の競合）, 422（数量/型不正）

12. **直前取り消し（任意）** `POST /picking/tasks/{id}/items/{item_result_id}/undo`

* 作用: 直近登録分の数量を巻き戻し（監査記録必須）。

---

## 6. バリデーション / ルール

* ログイン: `code` 必須、
* タスク取得: `warehouse_id` 必須。
* ピック登録:

    * `picked_qty > 0`（整数）
    * `picked_qty_type` は `planned_qty_type` に合致（相違時の換算はサーバ側定義がない限り不可）
    * 同時更新対策: 行にバージョン/ETag を付与し、競合時 409。
* 完了: 行に `PICKING` が残存する場合は 422（allow_short が真であれば `SHORTAGE` 完了可）。

---

## 7. エラーレスポンス（例）
基本的にはエラーもresponseを返す。

* `400` バリデーション: `{ message, errors: { field: [msg] } }`
* `401` 未認証 / 無効トークン
* `403` 権限不足
* `404` 未検出
* `409` 競合（割当済/並行更新/在庫予約の衝突）
* `422` 業務ルール違反（過剰/型不一致/未達完了禁止）
* `500` サーバエラー

---

